{% extends 'magazine/base.html' %}
{% load static %}
{%block title%}צבא השם - חיפוש{%endblock%}

{%block body%}
<style>

  .article-txt
  {
    display:flex;
    flex-direction:column;
    align-items:flex-start;
    justify-content:space-between;

  }
  .side-title
  {
    font-size: 2rem;
    color:#272728;
    font-weight: bolder;
    font-family:formal2;
    box-sizing: border-box;
    /*max-width:350px;*/
    line-height: 2rem;
    opacity: 0.9;
  }
  .grid-row
  {
  /*  display:grid;
    grid-template-columns: 300px [col1]  300px [col2];
    grid-template-rows: autofill [row] ;*/
  }
  .side-thumb
  {
    /*width:300px;*/
    height:100%;
    box-shadow: 0 0 10px black;
  }
  .equal-cols-height-row>*
  {
    width:400px;
  }
  .equal-cols-height-row
  {
    height:200px;
    display:flex;
    flex-direction:row;
    aligm-items:flex-start;
    justify-content:flex-start;
    gap:20px;
  }

  .all-posts-view
  {
    margin-top:50px;
    margin-bottom:50px;
    display:flex;
    flex-direction:column;
    gap:100px;
    align-items:center;
    width:100%;
  }
  .all-posts-view a
  {
    text-decoration: none;
  }

  .all-posts-body
  {
    width:100%;
    position:relative;
  }

 .pos-btm-left
 {
   font-size:1.25rem;
   font-family:formal2;
   font-weight:bold;
   text-decoration:none;
   display:flex;
   flex-direction:row;
   align-items:center;
   position:fixed;
   bottom:50px;
   left:50px;

 }
 .pos-btm-right
 {
   font-size:1.25rem;
   font-family:formal2;
   font-weight:bold;
   text-decoration:none;
   display:flex;
   flex-direction:row;
   align-items:center;
   position:fixed;
   bottom:50px;
   right:100px;
 }
 .red-hover
 {
   transition: 1s all;
 }
 .red-hover:hover
 {
   color:red;

 }
 .side-title:hover
 {
    color:blue;
 }
 .equal-cols-height-row:hover
 {
    -webkit-box-shadow: inset 0 0 1000px rgb(9, 239, 212, 0.5);
 }
</style>

<div class="all-posts-body">
  <div class="all-posts-view">
  {% for post in posts %}
    <a class="equal-cols-height-row search-item"  href="{%url 'magazine:anArticle' post.pk %}">
         <img style="opacity:0;" class="side-thumb" id="search-result-thumb{{ forloop.counter }}" onload="fadeInImg('search-result-thumb{{ forloop.counter }}')" src="{{post.thumb.url}}" alt="">
      <div class="article-txt">
         <div class="side-title">{{post.title | safe | slice:":100"}}</div>
         <div class="a-subtitle" style="justify-content:flex-start;">{{post.subtitle | safe | slice:":100"}}</div>
         {% if post.author.profile.profile_img.url %}
           <div class="author super-tiny-row-center-align" style="font-size:0.6rem;">
               <img class="very-tiny-avatar" src="{{post.author.profile.profile_img.url}}"/>
               <span class="author-search">{{post.author | safe}}</span> &nbsp; | &nbsp;
               <span class="date-search">{{post.datepublished | date:'d/m/Y' | safe}}</span>
           </div>
         {% else %}
         <div class="author super-tiny-row-center-align" style="font-size:0.6rem;">
             {% include 'members/default_profile_img.html' %}
             <span class="author-search">{{post.author | safe}}</span> &nbsp; | &nbsp;
             <span class="date-search">{{post.datepublished | date:'d/m/Y' | safe}}</span>
         </div>
         {% endif %}
         <div class="ice-cream-seperator"></div>
      </div>
    </a>




{% endfor %}

<div id="animated-fan">
  <div class="curve-stick-item curve-stick-item-right">
    <div class="curve-stick-item curve-stick-item-left">
      <div class="curve-stick-item curve-stick-item-right">
        <div class="curve-stick-item curve-stick-item-left">

        </div>
      </div>
    </div>
  </div>
</div>

  </div>

  <input type="hidden" id="searched" value="{{search}}">
  <audio style="display:none;" id="mouseclick" controls>
      <source src="{% static 'magazine/audio/mouseclick.mp3' %}" type="audio/mp3">
  </audio>
</div>

{% endblock body %}

{% block moreJs %}

<script>

function clone_search_result(thumb, title, subtitle, avatar, author, date_ , href)
{
  var elem_to_clone = $('.search-item').last();
  var num_of_items = $('.search-item').length + 1;
  var id = "search-result-thumb" + num_of_items;

  var cloned = $(elem_to_clone).clone(true);
  $(cloned).find('.side-thumb').attr('src', thumb);
  $(cloned).find('.side-thumb').attr('onload', "fadeInImg('"+ id +"')");
  $(cloned).find('.side-thumb').attr('id', id);
  $(cloned).find('.side-title').text(title);
  $(cloned).find('.a-subtitle').text(subtitle);
  $(cloned).find('.very-tiny-avatar').attr('src', avatar);
  $(cloned).find('.author-search').text(author);
  $(cloned).find('.date-search').text(date_);
  $(cloned).attr('href', href);
  $(elem_to_clone).after(cloned);
}

function call_clone_search_result(obj)
{
  var thumb = obj['thumb'];
  var title = slice_str(strip_tags(obj['title']), 100);
  var subtitle = slice_str(strip_tags(obj['subtitle']), 100);
  var date_ = obj['date_'];
  var avatar = obj['avatar'];
  var author = obj['author'];
  var href = obj['href'];
  clone_search_result(thumb, title, subtitle, avatar, author, date_ , href);
}

</script>
<script>
function load_more_results()
{
  var csrftoken = $('[name="csrfmiddlewaretoken"]').val();
     $.ajax({
         type: 'GET',
         url: "{% url 'magazine:load-more-matched-articles' %}",
         data: {'search':String($('#searched').val()),
               'num_of_posts_loaded':String($('.search-item').length),
               'csrfmiddlewaretoken': csrftoken,
         },
         dataType: 'json',
         success: function (response) {

           for(var i=0;i<response.length;i++)
           {
             var obj = response[i];
             call_clone_search_result(obj);

           }
           $('#animated-fan').css('display', 'none');
         },
         error: function (response) {
             console.log(response);
         }
     });
}
</script>

<script>
function show_fan_if_there__is_more_results_waiting()
{
  var csrftoken = $('[name="csrfmiddlewaretoken"]').val();
     $.ajax({
         type: 'GET',
         url: "{% url 'magazine:load-more-matched-articles' %}",
         data: {'search':String($('#searched').val()),
               'num_of_posts_loaded':String($('.search-item').length),
               'csrfmiddlewaretoken': csrftoken,
         },
         dataType: 'json',
         success: function (response) {

           if(response.length<=0)
           {
             return;
           }

           $('#animated-fan').css('display', 'flex');
         },
         error: function (response) {
             console.log(response);
         }
     });
}
</script>

<script>
  function is_at_the_bottom()
  {
    if($('#animated-fan').hasClass('activated-animated-fan') == false)
    {
      $('#animated-fan').addClass('activated-animated-fan');
    }

    var scrollHeight = $(document).height();
   var scrollPosition = $(window).height() + $(window).scrollTop();
    var bottom = 360;
   if (scrollHeight - scrollPosition < bottom ) {
      load_more_results();

      //reach to the ground
   }
    else
    {
      //not reach to the ground
    }
  }

  $(window).on("scroll", function() {
  	var scrollHeight = $(document).height();
  	var scrollPosition = $(window).height() + $(window).scrollTop();
    var bottom = 360;
  	if (scrollHeight - scrollPosition < bottom ) {
     show_fan_if_there__is_more_results_waiting();
      //load_more_results();
      //reach to the ground
  	}
    else
    {
      //not reach to the ground
    }
  });
</script>



{% endblock moreJs %}
