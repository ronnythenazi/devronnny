<!DOCTYPE html>
{%load static%}
{% load custom_tag_notification %}
<html lang="he-IL" dir="rtl">


  <head>
    <meta charset="utf-8">

  {%block meta%}
  {%endblock meta%}
    <title>{%block title%}בלוג יהודונאציזם{%endblock%}</title>
    <link rel = "shortcut icon" href="{% static 'images/judonazim.svg' %}" type="image/x-icon">
    <link rel="stylesheet" href="{% static 'magazine/css/magazine.css' %}">
    <link rel="stylesheet" href="{% static 'magazine/css/article.css' %}">
    <link rel="stylesheet" href="{% static 'magazine/css/global.css' %}">
    {%block moreLinks%} {%endblock moreLinks%}

 <script>

    /* document.onkeydown = function (e) {
          if (event.keyCode == 123) {
              return false;
          }
          if (e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'i'.charCodeAt(0))) {
              return false;
          }
          if (e.ctrlKey && e.shiftKey && (e.keyCode == 'C'.charCodeAt(0) || e.keyCode == 'c'.charCodeAt(0))) {
              return false;
          }
          if (e.ctrlKey && e.shiftKey && (e.keyCode == 'J'.charCodeAt(0) || e.keyCode == 'j'.charCodeAt(0))) {
              return false;
          }
          if (e.ctrlKey && (e.keyCode == 'U'.charCodeAt(0) || e.keyCode == 'u'.charCodeAt(0))) {
              return false;
          }
          if (e.ctrlKey && (e.keyCode == 'S'.charCodeAt(0) || e.keyCode == 's'.charCodeAt(0))) {
              return false;
          }
      }*/
    </script>

    <style>
    #bell-menu-item
    {
      box-sizing:border-box;
      align-self:flex-start;
      justify-content:flex-start;
      margin-top: 50px;

    }
    </style>
  </head>
<body>
<!--<body oncontextmenu="return false;">-->
    <div id="fb-root"></div>
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v12.0" nonce="GTakoGeS"></script>

     <div class="menu">



      <!-- start notification tag -->
      <!--{% if user.is_authenticated  %}-->

      <div class="menuItem not-bg-hover" id= "bell-menu-item">


        <!--<form id="ajax-notifications-form">-->

       {% show_notifications %}




      </div>


      <!--{% endif %}-->



       <!-- end notification tag -->
       {% if user.is_authenticated  %}

       <div class="menuItem not-bg-hover rotate-arrow-up" style="margin-right:30px;">
       <span class="scale-hover" style="font-size:1rem;color:white;">
         {{user.username | safe}}
       </span>
       {% if user.profile.profile_img.url %}
       <span class="scale-hover">
         <img src="{{user.profile.profile_img.url | safe}}" alt="" class="very-tiny-avatar">
         {% include 'magazine/components/svg/dropdownarrow.svg' %}
       </span>
       {% else %}
       <span class="scale-hover">{% include 'members/default_profile_img.html' %}
       {% include 'magazine/components/svg/dropdownarrow.svg' %}
       </span>
       {% endif %}

       <div>
         {% if user.profile.id %}
         <a class= "subMenuItem" href = "{% url 'users:UpdateProfile' user.profile.id %}">
           {% include 'magazine/components/svg/person_plus.svg' %}
         עדכן פרופיל
         </a>
         {% else %}
         <a class= "subMenuItem" href = "{% url 'users:CreateProfile' %}">
           {% include 'magazine/components/svg/person_plus.svg' %}
          צור פרופיל
         </a>
         {% endif %}
         <a class= "subMenuItem" href = "{% url 'users:profile_ctl' %}">
           {% include 'magazine/components/svg/setting.svg' %}
            עדכן חשבון
         </a>
         <a class="subMenuItem" href = "{% url 'users:change-password' %}">
           {% include 'magazine/components/svg/key.svg' %}
            שינוי סיסמא
         </a>
         <a class= "subMenuItem">
           {% include 'magazine/components/svg/mail.svg' %}
            תיבת דואר
         </a>
         <a class="subMenuItem" href="{% url 'logout' %}">

          <span>{% include 'magazine/components/svg/reverse.html' %} צא</span>
         </a>
       </div>
     </div>


       {% endif %}
       <a class="menuItem" href="{% url 'magazine:magazineNews' %}">
         <!--<span>דף הבית</span>-->
         {% include 'magazine/components/svg/homepage.html' %}
       </a>

       {% if not user.is_authenticated %}
       <a class="menuItem" href="{% url 'users:SignUp' %}">
         <span>הירשם</span>
         {% include 'magazine/components/svg/signup.html' %}
       </a>
       <a class="menuItem" href="{% url 'users:SignIn' %}">
        <span>התחבר</span>
       {% include 'magazine/components/svg/signin.html' %}
       </a>
       {% endif %}

       {% if user.is_authenticated %}

         {% if request.user.groups.all.0.name == 'owner' or request.user.groups.all.0.name == 'admin' %}
         <div class="menuItem">
      <!--    <span>האזור האישי</span>-->
           {% include 'magazine/components/svg/pen.html' %}
          <div>
          <a class="subMenuItem" href = "{% url 'magazine:myposts' %}">
           נהל בלוג אישי
          </a>
          <a class="subMenuItem" href="{% url 'magazine:enlightThePublic' %}">
            פרסם מאמר
          </a>

          {% if request.user.groups.all.0.name == 'owner'%}
          <a class="subMenuItem" href = "{% url 'magazine:userRoles' %}">
           ניהול מודרטורים והרשאות
          </a>
          {% endif %}
        </div>
       </div>
      {% endif %}



    {% endif %}
   <a id="judo-logo-wrap" href="{% url 'magazine:magazineNews' %}" class="ice-cream-clr" style="align-self:center;">
     <div class="super-tiny-row-center-align stroke-white">
     <span>יהודו</span>
     {% include 'magazine/components/svg/judonazim.svg' %}
     <span>נאציזם</span>
   </div>
 </a>

   <div id="more-info"  style="align-self:center;">
     <div class="super-tiny-row-center-align stroke-white">
     <a class="copyright"  href="{% url 'magazine:about_ronny_the_nazi' %}"  style="cursor:pointer;display:flex;flex-direction:row;align-items:center;">
       <img src="{% static 'images/ronny.jpg' %}" class="round-styled-small-img-smaller" alt="">
       <span class="text-muted">רוני הנאצי/יהודונאציזם</span>
       © 2021
     </a>
   </div>
   </div>
 </div>




     <div class="arrow-up"><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-arrow-up-short" viewBox="0 0 16 16">
   <path fill-rule="evenodd" d="M8 12a.5.5 0 0 0 .5-.5V5.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 1 0 .708.708L7.5 5.707V11.5a.5.5 0 0 0 .5.5z"/>
 </svg></div>
 <div style="display:flex;flex-direction:row; justify-content:flex-start;align-items:flex-start;">
{%include 'components/sharestickybar.html'%}
{%block body%}

{%endblock body%}
</div>
{%include 'components/footer.html'%}
  <script type="text/javascript" src="{% static 'plugins/jquery.js'%}"> </script>
  <script type="text/javascript" src="{% static 'magazine/js/magazine.js'%}"> </script>
  <script type="text/javascript" src="{% static 'magazine/js/posts.js'%}"> </script>
  <script type="text/javascript" src="{% static 'magazine/js/editPosts.js'%}"> </script>
  <script type="text/javascript" src="{% static 'magazine/js/global.js'%}"> </script>
  <!--<script type="text/javascript" src="{% static 'magazine/js/ajax.js'%}"> </script>-->


 <script>
  /*$(document).bind("contextmenu", function(e) {
     e.preventDefault();
  });*/

</script>

{% csrf_token %}
<script>
$(document).ready(function(){

 setInterval(check_notficiations, 10000);
});

  function check_notficiations()
  {

       var last_notification_date = $('#last_notification_date').val();


       var csrftoken = $('[name="csrfmiddlewaretoken"]').val()
          $.ajax({
              type: 'GET',
              url: "{% url 'social:ajax-notifications' %}",
              data: {'last_notification_date':last_notification_date,
                    'csrfmiddlewaretoken': csrftoken,
              },
              dataType: 'json',
              success: function (response) {
              var result = JSON.parse(response["next_notifications"]);

              if(result.length == 0)
              {
                return;
              }
              var next_notification = result[0]['fields'];
              var notification_pk = result[0]['pk']

              var from_user = result[1]['fields']['username']; //new
              alert(from_user);


              render_new_notifications(next_notification, notification_pk );

              },
              error: function (response) {
                  console.log(response);
              }
          })
    }



  function render_new_notifications(next_notification, notification_pk)
  {

    var cnt = parseInt($('.notification-counter').text());
    cnt = cnt + 1;
    $('.notification-counter').text(cnt);

    $('#ring-the-bell').show();
    $('#dont-ring-the-bell').hide();

    var parent = $('.notification-content');

    var curr_date = next_notification["date"];

       $('#last_notification_date').val(String(curr_date));





      if(next_notification["post"])
      {

        if(String(next_notification["notification_type"]) == "1")
        {
          msg= "נתן לך לייק לפוסט";
          var elem = build_notification_object(msg, next_notification["notification_type"], next_notification["from_user"], 'post-notification', notification_pk, next_notification['post']);
          $(parent).prepend(elem);
        }
        else if(String(next_notification["notification_type"]) == "4")
        {
          msg= "נתן לך דיסלייק לפוסט";
          var elem = build_notification_object(msg, next_notification["notification_type"], next_notification["from_user"], 'post-notification', notification_pk, next_notification['post']);
          $(parent).prepend(elem);
        }
      }
      else if(next_notification["comment"])
      {
        var csrftoken = $('[name="csrfmiddlewaretoken"]').val()
           $.ajax({
               type: 'GET',
               url: "{% url 'social:ajax_notification_comment' %}",
               data: {'comment_id':next_notification['comment'],
                     'csrfmiddlewaretoken': csrftoken,
               },
               dataType: 'json',
               success: function (response) {
               var result = JSON.parse(response["comment"]);
               if(result.length == 0)
               {
                 return;
               }
               var comment = result[0]['fields'];
               var comment_pk = result[0]['pk']

               if(String(next_notification["notification_type"]) == "1")
               {
                 msg= "נתן לך לייק לתגובה";
                alert(next_notification["from_user"])

                 var elem = build_notification_object(msg, next_notification["notification_type"], next_notification["from_user"], 'comment-notification', notification_pk, comment['post'], next_notification['comment']);
                 $(parent).prepend(elem);
               }
               else if(String(next_notification["notification_type"]) == "2")
               {
                 msg= "הגיב לך על המאמר";
                 var elem = build_notification_object(msg, next_notification["notification_type"], next_notification["from_user"], 'comment-notification', notification_pk, comment['post'], next_notification['comment']);
                 $(parent).prepend(elem);
               }
               else
               {
                 msg= "נתן לך דיסלייק לתגובה";
                 var elem = build_notification_object(msg, next_notification["notification_type"], next_notification["from_user"], 'comment-notification', notification_pk, comment['post'], next_notification['comment']);
                 $(parent).prepend(elem);
               }
             },
               error: function (response) {
                   console.log(response);
               }


             })
      }
      else if(next_notification["com_of_com"])
      {

        var csrftoken = $('[name="csrfmiddlewaretoken"]').val()
           $.ajax({
               type: 'GET',
               url: "{% url 'social:ajax_notification_com_of_com' %}",
               data: {'com_of_com_id':next_notification["com_of_com"],
                     'csrfmiddlewaretoken': csrftoken,
               },
               dataType: 'json',
               success: function (response) {
               var result = JSON.parse(response["com_of_com"]);
               if(result.length == 0)
               {
                 return;
               }
               var com_of_com = result[0]['fields'];
               var com_of_com_pk = result[0]['pk'];
               $.ajax({
                 type: 'GET',
                 url: "{% url 'social:ajax_notification_comment' %}",
                 data:{'comment_id':com_of_com['comment'],
                 'csrfmiddlewaretoken': csrftoken,
               },
                 dataType: 'json',
                 success: function (response2) {
                   var result2 = JSON.parse(response2["comment"]);
                   var comment = result2[0]['fields']
                   var post =comment['post']
                   if(String(next_notification["notification_type"]) == "1")
                   {


                     msg= "נתן לך לייק";
                     var elem = build_notification_object(msg, next_notification["notification_type"], next_notification["from_user"], 'com-of-com-notification', notification_pk, post, com_of_com['comment'], com_of_com_pk);
                     $(parent).prepend(elem);
                   }
                   else if(String(next_notification["notification_type"]) == "2")
                   {
                     msg= "הגיב לך";
                     var elem = build_notification_object(msg, next_notification["notification_type"], next_notification["from_user"], 'com-of-com-notification', notification_pk, post, com_of_com['comment'], com_of_com_pk);
                     $(parent).prepend(elem);

                   }
                   else
                   {
                     msg= "נתן לך דיסלייק";
                     var elem = build_notification_object(msg, next_notification["notification_type"], next_notification["from_user"], 'com-of-com-notification', notification_pk, post, com_of_com['comment'], com_of_com_pk);
                     $(parent).prepend(elem);

                   }
                 },

               error: function (response) {
                   console.log(response);
               }
             })

           },


               error: function (response) {
                   console.log(response);
               }


             })
      }
      else
      {

        msg= "החל לעקוב אחריך";
        var elem = build_notification_object(msg, next_notification["notification_type"], next_notification["from_user"], 'follow-notification', notification_pk, next_notification['from_user']);
        $(parent).prepend(elem);
      }



  }

  function build_notification_object(msg, notification_type, from_user,  view_name, notification_pk, ...args)
  {
   var obj = '<div class="subMenuItem notification">';

   var a1 = '<a href="' + "{% url +  'social:remove-notification' " + notification_pk;
    a1 += "%}?prev_page={{  path | urlencode }}" + '">';

    a1 += '<svg xmlns="http://www.w3.org/2000/svg width="20" height="20" fill="black" class="bi bi-x"';
    a1+= ' viewBox="0 0 16 16">';
    a1 += '<path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"';
    a1 += '/></svg></a>';


   var a2 = '<a href="' + "{% url +  'social:" + view_name + "' ";

   a2 = a2 + notification_pk + " ";
   for(var param in args)
   {
     a2 = a2 + param + " ";
   }
   a2 += '%}">';
   a2 += "@{{" + from_user + "}}" + msg +  "</a>";
   obj = obj + a1 + a2 + "</div>";
   return obj;


  }




</script>


  {%block moreJs%} {%endblock moreJs%}

  </body>

</html>
